import paramiko
from scp import SCPClient
import time

class VPSManager:
    def __init__(self, hostname, port, username, key_path):
        self.hostname = hostname
        self.port = port
        self.username = username
        self.key_path = key_path
        self.ssh = None
        self.scp = None

    def connect(self):
        """å»ºç«‹SSHè¿æ¥"""
        try:
            # åˆ›å»ºSSHå®¢æˆ·ç«¯
            self.ssh = paramiko.SSHClient()
            self.ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            
            # åŠ è½½ç§é’¥
            key = paramiko.RSAKey.from_private_key_file(self.key_path)
            
            # å»ºç«‹è¿æ¥
            self.ssh.connect(
                hostname=self.hostname,
                port=self.port,
                username=self.username,
                pkey=key
            )
            print("âœ… æˆåŠŸè¿æ¥åˆ°VPS")
            
            # åˆå§‹åŒ–SCPå®¢æˆ·ç«¯
            self.scp = SCPClient(self.ssh.get_transport())
            
        except Exception as e:
            print(f"âŒ è¿æ¥å¤±è´¥: {str(e)}")
            raise

    def execute_command(self, command):
        """æ‰§è¡Œè¿œç¨‹å‘½ä»¤"""
        if not self.ssh:
            print("âš ï¸ è¯·å…ˆå»ºç«‹è¿æ¥")
            return None
        
        stdin, stdout, stderr = self.ssh.exec_command(command)
        output = stdout.read().decode()
        error = stderr.read().decode()
        
        if error:
            print(f"âŒ å‘½ä»¤æ‰§è¡Œå‡ºé”™:\n{error}")
        else:
            print(f"ğŸ“¤ å‘½ä»¤è¾“å‡º:\n{output}")
        
        return output

    def transfer_file(self, local_path, remote_path):
        """ä¸Šä¼ æ–‡ä»¶"""
        if not self.scp:
            print("âš ï¸ è¯·å…ˆå»ºç«‹è¿æ¥")
            return False
            
        try:
            self.scp.put(local_path, remote_path)
            print(f"ğŸ“¥ æ–‡ä»¶å·²ä¸Šä¼ è‡³ {remote_path}")
            return True
        except Exception as e:
            print(f"âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {str(e)}")
            return False

    def close(self):
        """å…³é—­è¿æ¥"""
        if self.scp:
            self.scp.close()
        if self.ssh:
            self.ssh.close()
        print("ğŸ”Œ è¿æ¥å·²å…³é—­")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # é…ç½®ä¿¡æ¯ï¼ˆå»ºè®®å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼‰
    config = {
        "hostname": "your.vps.ip",
        "port": 22,
        "username": "root",
        "key_path": "~/.ssh/your_private_key"
    }

    vps = VPSManager(**config)
    
    try:
        vps.connect()
        
        # ç¤ºä¾‹1ï¼šæ›´æ–°ç³»ç»Ÿ
        vps.execute_command("sudo apt update && sudo apt upgrade -y")
        
        # ç¤ºä¾‹2ï¼šåˆ›å»ºç›®å½•
        vps.execute_command("mkdir -p ~/my_scripts")
        
        # ç¤ºä¾‹3ï¼šä¸Šä¼ æ–‡ä»¶
        vps.transfer_file("local_script.sh", "~/my_scripts/remote_script.sh")
        
        # ç¤ºä¾‹4ï¼šè®¾ç½®æ‰§è¡Œæƒé™
        vps.execute_command("chmod +x ~/my_scripts/remote_script.sh")
        
        # ç¤ºä¾‹5ï¼šæ‰§è¡Œè„šæœ¬
        vps.execute_command("~/my_scripts/remote_script.sh")
        
    finally:
        vps.close()
